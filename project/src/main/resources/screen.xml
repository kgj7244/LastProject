<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace xml을 구별하기 위한 이름 -->
<!-- resultMap는 table에 컬럼명과 class에 dept변수명이 다를 때 mapping하는 용도 -->

<mapper namespace="screenns">
	<resultMap type="screen" id="screenResult">
		<result property="sc_num" column="sc_num"/>
		<result property="sc_date"  column="sc_date"/>
		<result property="sc_start" 	  column="sc_start"/>
		<result property="sc_end"  column="sc_end"/>
		<result property="t_num" 	  column="t_num"/>
		<result property="mt_num"  column="mt_num"/>
		<result property="m_num" 	  column="m_num"/>
		<result property="mt_name"  column="mt_name"/>
		<result property="cnt" 	  column="cnt"/>
	</resultMap>
	<select id="selectTitleList" parameterType="hashmap" resultMap="screenResult">
		<!-- select s.*, m.mt_name from screen s, movieTheater m where s.mt_num = m.mt_num and s.t_num = #{theater_num} and s.m_num = #{movie_num} and s.sc_date = #{sc_date} and s.sc_del = 'n' order by s.sc_start -->
		<!-- select s.*, m.mt_name, nvl(seatCount,0) 
		from screen s, movieTheater m, (select sc_num, count(*) seatCount from seat group by sc_num) ct 
		where s.mt_num = m.mt_num and s.t_num = #{theater_num} and s.sc_num = ct.sc_num and s.m_num = #{movie_num} and s.sc_date = #{sc_date} and s.sc_del = 'n' order by s.sc_start -->
		select s.sc_num, s.sc_date, s.sc_start, s.sc_end, s.t_num, s.mt_num, s.m_num, m.mt_name, mt_name, nvl(ct.cnt,0) cnt
		from screen s, movieTheater m, (select sc_num, count(*) cnt from seat group by sc_num) ct 
		where s.mt_num = m.mt_num and s.t_num = #{theater_num} and s.sc_num = ct.sc_num(+) and s.m_num = #{movie_num} and s.sc_date = #{sc_date} and s.sc_del = 'n' 
        order by s.sc_start
	</select>
	<select id="selectCnt" parameterType="integer">
		select mt_count from screen s, movieTheater m where s.t_num = m.t_num
	</select>
	<select id="select" parameterType="hashmap" resultType="screen">
		select s.*, m.mt_num from screen s, movieTheater m where s.t_num = m.t_num and s.sc_num = #{sc_num} and m.mt_num =#{mt_num} and s.sc_del = 'n'
	</select>
	<select id="selectMovieTheater" parameterType="hashmap" resultType="movieTheater">
	<!-- mt_num,sc_start,sc_date -->
		select * from screen s, movieTheater m where s.t_num = m.t_num and m.mt_num=#{mt_num} and s.sc_start =#{sc_start} and sc_date = #{sc_date} and s.sc_del = 'n'
	</select>
	<select id="selectMovieTheaterFind" parameterType="hashmap" resultType="movieTheater">
		select * from screen s, movieTheater m where s.t_num = m.t_num and m.mt_num = #{mt_num} and s.sc_num =#{sc_num} and s.sc_del = 'n'
	</select>
	<select id="list" resultType="movieTheater">
		select * from movieTheater
	</select>
	<select id="selectTitle" parameterType="String" resultType="movieTheater">
		select * from movieTheater where mt_name =#{mt_name} and t_num = #{t_num}
	</select>
	<insert id="screenInsert" parameterType="hashmap">
		insert into screen values(sc_num.nextval, #{sc_date},#{sc_start},#{sc_end},'n',#{t_num},#{mt_num},#{m_num})
	</insert>
	<select id="selectSeat" parameterType="Integer" resultType="screen">
		select * from screen where sc_num = #{sc_num}
		<!-- select sc_num, sc_date, sc_start, sc_end, nvl(st_name, 'x'), sc_del, t_num, mt_num, m_num from screen where sc_num = #{sc_num} -->
	</select>
	<update id="insertSeat" parameterType="hashmap">
		update screen set st_name =#{st_name} where sc_num = #{sc_num}
	</update>
	<update id="screenReFund" parameterType="hashmap">
		update screen set st_name= #{seat} where sc_num = #{sc_num}
	</update>
	<delete id="bankReFund" parameterType="hashmap">
		delete from bank where t_ordernum = #{t_ordernum} and member_id =#{member_id}
	</delete>
	<delete id="ticketReFund" parameterType="hashmap">
		delete from ticket where t_ordernum = #{t_ordernum} and sc_num = #{sc_num}
	</delete>
	
	<!-- 새로운 -->
	<insert id="newInsertSeat" parameterType="hashmap">
		insert into seat values(#{seat}, #{sc_num})
	</insert>
	<select id="seatFind" parameterType="integer" resultType="seat">
		select * from seat where sc_num = #{sc_num}
	</select>
	<delete id="deleteSeatReFund" parameterType="hashmap">
		delete from seat where sc_num=#{sc_num} and st_num = #{st_num}
	</delete>
	<select id="selectTheater" parameterType="string" resultType="theater">
		select * from theater where t_title = #{t_title}
	</select>
	<select id="mTheater" parameterType="integer" resultType="movieTheater">
	    select * from movieTheater where t_num =#{t_num} order by mt_name
	</select>
	
	<!-- 이벤트 -->
	<insert id="insertEvent" parameterType="event">
		insert into event values (e_num.nextval , #{e_title}, #{e_state}, #{e_sale},#{e_poster},'n')
	</insert>
	<select id="eventList" resultType="event">
		select * from event where e_del ='n' order by e_num
	</select>
	<select id="eventFind" parameterType="hashmap" resultType="Event_over">
		select * from event_over where member_id = #{member_id} and e_num =#{e_num}
	</select>
	<insert id="event_overInsert" parameterType="hashmap">
		insert into event_over values(eo_num.nextval, #{member_id}, '대기', #{e_num})
	</insert>
	<select id="event_overList" resultType="event_over">
		select * from event_over where eo_state = '대기'
	</select>
	<update id="rankUp" parameterType="integer">
		update event_over set eo_state = '발급' where eo_num = #{eo_num}
	</update>
	<delete id="eventCancel" parameterType="integer">
		delete from event_over where eo_num = #{eo_num}
	</delete>
	<select id="selectEvent" parameterType="integer" resultType="event">
		select * from event where e_num = #{e_num}
	</select>
	<update id="eventUpdate" parameterType="event">
		update event set e_title=#{e_title}, e_state =#{e_state}, e_sale= #{e_sale}, e_poster =#{e_poster} where e_num = #{e_num}
	</update>
	<update id="eventDelete" parameterType="integer">
		update event set e_del='y' where e_num=#{e_num}
	</update>
	<select id="coupon" parameterType="string" resultType="event_over">
		select * from event_over where member_id=#{member_id}
	</select>
</mapper>